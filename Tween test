--[[
ESP Script with Red Boxes, Toggle Button, and Open/Close GUI
Tested for Roblox Lua (LocalScript). Place this in StarterPlayerScripts for best results.
--]]

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Variables
local localPlayer = Players.LocalPlayer
local espEnabled = false
local guiOpen = true
local espDrawings = {}

-- Functions to manage ESP
local function createESPForCharacter(character)
    if not character then return end
    local head = character:FindFirstChild("Head")
    if not head then return end

    -- BillboardGui for ESP (red frame)
    local bb = Instance.new("BillboardGui")
    bb.Name = "RedESP"
    bb.Adornee = head
    bb.Size = UDim2.new(4,0,5,0)
    bb.AlwaysOnTop = true
    bb.StudsOffset = Vector3.new(0, 1.5, 0)

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1,0,1,0)
    frame.BackgroundTransparency = 1
    frame.BorderSizePixel = 0

    local redOutline = Instance.new("UIStroke")
    redOutline.Thickness = 4
    redOutline.Color = Color3.new(1,0,0)
    redOutline.Parent = frame

    frame.Parent = bb
    bb.Parent = game.CoreGui

    return bb
end

local function removeAllESP()
    for _, bb in ipairs(espDrawings) do
        if bb and bb.Parent then
            bb:Destroy()
        end
    end
    espDrawings = {}
end

local function updateESP()
    removeAllESP()
    if not espEnabled then return end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local bb = createESPForCharacter(player.Character)
            if bb then
                table.insert(espDrawings, bb)
            end
        end
    end
end

-- UI Creation
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPControlGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = game.CoreGui

local mainFrame = Instance.new("Frame")
mainFrame.Position = UDim2.new(0.75,0,0.3,0)
mainFrame.Size = UDim2.new(0,200,0,120)
mainFrame.BackgroundColor3 = Color3.new(0.15,0.15,0.15)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = guiOpen
mainFrame.Parent = screenGui

local openCloseBtn = Instance.new("TextButton")
openCloseBtn.Size = UDim2.new(0,200,0,30)
openCloseBtn.Position = UDim2.new(0,0,0,0)
openCloseBtn.Text = "Fechar Painel"
openCloseBtn.BackgroundColor3 = Color3.new(0.2,0.2,0.2)
openCloseBtn.TextColor3 = Color3.new(1,1,1)
openCloseBtn.Parent = mainFrame

local toggleESPBtn = Instance.new("TextButton")
toggleESPBtn.Size = UDim2.new(0,180,0,40)
toggleESPBtn.Position = UDim2.new(0,10,0,40)
toggleESPBtn.Text = "Ativar ESP"
toggleESPBtn.BackgroundColor3 = Color3.new(0.8,0,0)
toggleESPBtn.TextColor3 = Color3.new(1,1,1)
toggleESPBtn.Parent = mainFrame

local openBtn = Instance.new("TextButton")
openBtn.Size = UDim2.new(0,80,0,30)
openBtn.Position = UDim2.new(0.75,0,0.25,0)
openBtn.Text = "Abrir"
openBtn.BackgroundColor3 = Color3.new(0.2,0.2,0.2)
openBtn.TextColor3 = Color3.new(1,1,1)
openBtn.Visible = not guiOpen
openBtn.Parent = screenGui

-- Button Functionality
openCloseBtn.MouseButton1Click:Connect(function()
    guiOpen = false
    mainFrame.Visible = false
    openBtn.Visible = true
end)

openBtn.MouseButton1Click:Connect(function()
    guiOpen = true
    mainFrame.Visible = true
    openBtn.Visible = false
end)

toggleESPBtn.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    toggleESPBtn.Text = espEnabled and "Desativar ESP" or "Ativar ESP"
    toggleESPBtn.BackgroundColor3 = espEnabled and Color3.new(0,0.8,0) or Color3.new(0.8,0,0)
    updateESP()
end)

-- Auto-update ESP on character updates
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if espEnabled then
            wait(1)
            updateESP()
        end
    end)
end)

Players.PlayerRemoving:Connect(function()
    updateESP()
end)

-- Reapply ESP when toggled
RunService.RenderStepped:Connect(function()
    if espEnabled then
        updateESP()
    end
end)

-- Cleanup on script removal
screenGui.AncestryChanged:Connect(function(_, parent)
    if not parent then
        removeAllESP()
    end
end)
